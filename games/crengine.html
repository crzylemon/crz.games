<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRENGINE</title>
<style>
    html {width:fit-content; height:fit-content;}
    body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; width: fit-content; height: fit-content; }
    canvas { display: block; background: #222; }
    #console {
        position: absolute;
        top: 10px;
        left: 10px;
        width: calc(100% - 20px);
        height: calc(100% - 20px);
        background: rgba(0, 0, 0, 0.9);
        color: rgb(255, 255, 255);
        padding: 10px;
        box-sizing: border-box;
        display: none;
        flex-direction: column;
        z-index: 10;
    }
    #console-output {
        flex: 1;
        overflow-y: auto;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    #console-input {
        background: transparent;
        border: none;
        color: rgb(255, 255, 255);
        font-family: inherit;
        font-size: 12px;
        outline: none;
        padding: 5px 0;
    }
    #console-suggestions {
        background: rgba(0, 0, 0, 0.8);
        color: rgb(199, 199, 199);
        font-size: 11px;
        max-height: 100px;
        overflow-y: auto;
        display: none;
    }
    .suggestion {
        padding: 2px 5px;
        cursor: pointer;
    }
    .suggestion:hover {
        background: rgba(0, 255, 0, 0.2);
    }
    #console-prompt {
        color: rgb(255, 255, 255);
        font-family: inherit;
        font-size: 12px;
    }
    #gameCanvas {
        width: 100%;
        height: 100%;
        display: block;
    }
    #errorPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: #f00;
        padding: 20px;
        border: 2px solid #f00;
        font-family: monospace;
        z-index: 1000;
        display: none;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
    }
    #errorPopup button {
        margin: 5px;
        padding: 10px;
        background: #333;
        color: #fff;
        border: 1px solid #666;
        cursor: pointer;
    }
</style>
</head>
<body>
    <div id="gamecontainer" style="width: 1280px; height: 720px; position: relative;">
        <canvas id="gameCanvas"></canvas>
        <div id="console">
            <div id="console-output"></div>
            <div id="console-suggestions"></div>
            <div style="display: flex;">
                <span id="console-prompt">] </span>
                <input type="text" id="console-input" placeholder="Enter command..." style="flex: 1;">
            </div>
        </div>
    </div>
    <div id="errorPopup"></div>
<script src="crengine.js"></script>
<script>
fetch(`${baseURL}${gameName}/bin/client.cre?v=${Date.now()}`)
  .then(r => r.text())
  .then(code => {
    gameCode = code;
    const firstLine = code.split('\n')[0];
    
    if (!firstLine.startsWith('//{"META":')) {
        cre.Msg("No meta tag");
        try {
            new Function("ENGINE", code)(cre);
        } catch (e) {
            showError(e);
        }
        return;
    }
    
    try {
        const metaJson = firstLine.substring(2);
        const meta = JSON.parse(metaJson);
        
        if (meta.META && meta.META.version && meta.META.version !== cre.version) {
            if (confirm(`Wrong version, do you want to try anyway?`)) {
                new Function("ENGINE", code)(cre);
            }
        } else {
            new Function("ENGINE", code)(cre);
        }
    } catch (e) {
        if (e.name === 'SyntaxError') {
            cre.Msg("Invalid meta tag format");
        }
        showError(e);
    }
  })
  .catch(() => {
    cre.Msg(`Failed to load ${gameName}/bin/client.cre, loading default game.cre`);
    return fetch(`game.cre?v=${Date.now()}`)
      .then(r => r.text())
      .then(code => {
        gameCode = code;
        try {
            new Function("ENGINE", code)(cre);
        } catch (e) {
            showError(e);
        }
      });
  }); 
// Console toggle and input handling
</script>
</body>
</html>
